<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PermitBot ‚Äî Construction Permit Lead Intelligence</title>
<style>
  :root {
    --bg: #0f1117; --surface: #1a1d27; --surface2: #22263a; --border: #2e3347;
    --accent: #f59e0b; --text: #e2e8f0; --muted: #64748b; --green: #10b981;
    --risk-high: #ef4444; --risk-med: #f59e0b; --risk-low: #10b981;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: 14px; }

  header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 0 24px; display: flex; align-items: center; justify-content: space-between; height: 56px; }
  .logo { display: flex; align-items: center; gap: 10px; }
  .logo-icon { width: 32px; height: 32px; background: var(--accent); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
  .logo-text { font-size: 18px; font-weight: 700; }
  .logo-sub { font-size: 11px; color: var(--muted); }
  .live-badge { background: var(--green); color: #fff; font-size: 11px; font-weight: 600; padding: 3px 10px; border-radius: 20px; }

  .stats-bar { display: grid; grid-template-columns: repeat(5, 1fr); background: var(--border); border-bottom: 1px solid var(--border); gap: 1px; }
  .stat-card { background: var(--surface); padding: 14px 20px; }
  .stat-label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
  .stat-value { font-size: 22px; font-weight: 700; color: var(--accent); }
  .stat-sub { font-size: 11px; color: var(--muted); margin-top: 2px; }
  .stat-value.red { color: var(--risk-high); }
  .stat-value.yellow { color: var(--risk-med); }
  .stat-value.green-v { color: var(--risk-low); }

  .main { display: grid; grid-template-columns: 260px 1fr; min-height: calc(100vh - 57px - 90px); }

  .sidebar { background: var(--surface); border-right: 1px solid var(--border); padding: 20px; overflow-y: auto; }
  .sidebar-section { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
  .sidebar-section:last-child { border-bottom: none; }
  .sidebar h3 { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--muted); margin-bottom: 12px; }
  .filter-label { font-size: 12px; color: var(--muted); margin-bottom: 6px; display: block; }
  select, input { width: 100%; background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; color: var(--text); padding: 8px 10px; font-size: 13px; outline: none; }
  select:focus, input:focus { border-color: #3b82f6; }
  .filter-group { margin-bottom: 14px; }
  .btn { width: 100%; padding: 10px; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; font-weight: 600; }
  .btn-primary { background: var(--accent); color: #000; margin-bottom: 8px; }
  .btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .btn:hover { opacity: 0.85; }

  .city-pills { display: flex; flex-wrap: wrap; gap: 5px; }
  .pill { padding: 4px 10px; border-radius: 20px; border: 1px solid var(--border); background: var(--surface2); cursor: pointer; font-size: 11px; font-weight: 500; }
  .pill.active { background: var(--accent); border-color: var(--accent); color: #000; }

  .risk-pills { display: flex; gap: 6px; }
  .risk-pill { flex: 1; padding: 8px 4px; border-radius: 8px; border: 2px solid var(--border); background: var(--surface2); cursor: pointer; font-size: 11px; font-weight: 700; text-align: center; text-transform: uppercase; letter-spacing: 0.5px; }
  .risk-pill[data-risk="all"].active, .risk-pill[data-risk="all"] { border-color: var(--border); color: var(--muted); }
  .risk-pill[data-risk="all"].active { border-color: #3b82f6; color: #3b82f6; background: #1e2d45; }
  .risk-pill[data-risk="high"] { border-color: #3d1515; color: #ef4444; }
  .risk-pill[data-risk="high"].active { background: #3d1515; border-color: var(--risk-high); }
  .risk-pill[data-risk="medium"] { border-color: #3d2e15; color: #f59e0b; }
  .risk-pill[data-risk="medium"].active { background: #3d2e15; border-color: var(--risk-med); }
  .risk-pill[data-risk="low"] { border-color: #153d25; color: #10b981; }
  .risk-pill[data-risk="low"].active { background: #153d25; border-color: var(--risk-low); }

  .results { padding: 20px; overflow: auto; }
  .results-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 14px; }
  .results-count { font-size: 13px; color: var(--muted); }
  .results-count strong { color: var(--text); }
  .click-hint { font-size: 11px; color: var(--muted); font-style: italic; margin-top: 3px; }
  .export-btn { background: var(--surface2); border: 1px solid var(--border); color: var(--text); padding: 7px 14px; border-radius: 6px; cursor: pointer; font-size: 12px; white-space: nowrap; }

  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  thead th { text-align: left; padding: 10px 10px; border-bottom: 1px solid var(--border); color: var(--muted); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; background: var(--bg); position: sticky; top: 0; }
  tbody tr { border-bottom: 1px solid var(--border); cursor: pointer; border-left: 3px solid transparent; }
  tbody tr:hover { background: var(--surface2); }
  tbody tr.risk-high { border-left-color: var(--risk-high); }
  tbody tr.risk-medium { border-left-color: var(--risk-med); }
  tbody tr.risk-low { border-left-color: var(--risk-low); }
  tbody td { padding: 9px 10px; }

  .city-tag { display: inline-block; padding: 2px 7px; border-radius: 4px; font-size: 11px; font-weight: 600; text-transform: uppercase; white-space: nowrap; }
  .city-tag { background: var(--surface2); color: var(--muted); }

  .value-cell { font-weight: 600; color: var(--green); }
  .value-zero { color: var(--muted); }
  .trunc { max-width: 140px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

  /* Risk badge */
  .risk-badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 7px; border-radius: 5px; font-size: 11px; font-weight: 700; white-space: nowrap; }
  .risk-badge.HIGH { background: rgba(239,68,68,0.15); color: var(--risk-high); border: 1px solid rgba(239,68,68,0.3); }
  .risk-badge.MEDIUM { background: rgba(245,158,11,0.15); color: var(--risk-med); border: 1px solid rgba(245,158,11,0.3); }
  .risk-badge.LOW { background: rgba(16,185,129,0.15); color: var(--risk-low); border: 1px solid rgba(16,185,129,0.3); }
  .risk-badge.UNKNOWN { background: var(--surface2); color: var(--muted); border: 1px solid var(--border); }

  .state-center { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px; color: var(--muted); gap: 12px; }
  .spinner { width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Modal */
  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.75); z-index: 100; align-items: center; justify-content: center; padding: 20px; }
  .modal-overlay.open { display: flex; }
  .modal { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; width: 100%; max-width: 620px; max-height: 90vh; overflow-y: auto; }
  .modal-header { padding: 20px 24px 16px; border-bottom: 1px solid var(--border); display: flex; align-items: flex-start; justify-content: space-between; gap: 12px; }
  .modal-header h2 { font-size: 16px; font-weight: 600; line-height: 1.3; }
  .modal-close { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 22px; line-height: 1; flex-shrink: 0; }
  .modal-close:hover { color: var(--text); }
  .modal-body { padding: 20px 24px 24px; }

  .modal-section { margin-bottom: 20px; }
  .modal-section-title { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--muted); margin-bottom: 10px; }
  .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .detail-item { background: var(--surface2); border-radius: 8px; padding: 12px; }
  .detail-item.full { grid-column: 1 / -1; }
  .detail-item label { font-size: 11px; color: var(--muted); display: block; margin-bottom: 4px; }
  .detail-item .val { font-size: 14px; font-weight: 500; }
  .val-big { font-size: 24px; font-weight: 700; color: var(--green); }

  /* Risk meter */
  .risk-section { background: var(--surface2); border-radius: 10px; padding: 16px; margin-bottom: 10px; }
  .risk-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
  .risk-title { font-size: 13px; font-weight: 600; }
  .risk-bars { display: flex; flex-direction: column; gap: 10px; }
  .risk-bar-row { display: flex; align-items: center; gap: 10px; }
  .risk-bar-label { font-size: 12px; color: var(--muted); width: 80px; flex-shrink: 0; }
  .risk-bar-track { flex: 1; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; }
  .risk-bar-fill { height: 100%; border-radius: 4px; transition: width 0.3s; }
  .risk-bar-score { font-size: 12px; font-weight: 700; width: 30px; text-align: right; flex-shrink: 0; }
  .risk-bar-note { font-size: 11px; color: var(--muted); margin-top: 8px; line-height: 1.4; }

  .description-box { background: var(--surface2); border-radius: 8px; padding: 14px; font-size: 13px; line-height: 1.6; }
  .modal-actions { display: flex; gap: 8px; margin-top: 16px; }
  .modal-btn { flex: 1; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--surface2); color: var(--text); cursor: pointer; font-size: 13px; font-weight: 500; }
  .modal-btn:hover { border-color: var(--muted); }

  .quick-btn { width: 100%; padding: 9px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--surface2); color: var(--text); cursor: pointer; font-size: 12px; font-weight: 500; text-align: left; transition: border-color 0.15s, background 0.15s; }
  .quick-btn:hover { border-color: var(--accent); background: #2a2400; color: var(--accent); }

  .api-section { background: var(--surface); border-top: 1px solid var(--border); padding: 16px 24px; }
  .api-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
  .api-card { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 14px; }
  .api-card h4 { font-size: 13px; font-weight: 600; margin-bottom: 6px; }
  .api-card p { font-size: 12px; color: var(--muted); line-height: 1.5; }
  .api-endpoint { font-family: monospace; font-size: 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; padding: 5px 8px; margin-top: 6px; color: #38bdf8; word-break: break-all; }

  @media (max-width: 900px) {
    .stats-bar { grid-template-columns: repeat(3, 1fr); }
    .main { grid-template-columns: 1fr; }
    .api-grid { grid-template-columns: repeat(2, 1fr); }
    .detail-grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-icon">üèóÔ∏è</div>
    <div>
      <div class="logo-text">PermitBot</div>
      <div class="logo-sub">Construction Permit Lead Intelligence</div>
    </div>
  </div>
  <div class="live-badge">‚óè LIVE</div>
</header>

<div class="stats-bar">
  <div class="stat-card"><div class="stat-label">Total Permits</div><div class="stat-value" id="stat-total">‚Äî</div><div class="stat-sub">south of I-70 + CA</div></div>
  <div class="stat-card"><div class="stat-label">ZIP Codes Scored</div><div class="stat-value" id="stat-zips">‚Äî</div><div class="stat-sub">risk index coverage</div></div>
  <div class="stat-card"><div class="stat-label">üî¥ High Risk</div><div class="stat-value red" id="stat-high">‚Äî</div><div class="stat-sub">crime + fire score ‚â•7</div></div>
  <div class="stat-card"><div class="stat-label">üü° Medium Risk</div><div class="stat-value yellow" id="stat-med">‚Äî</div><div class="stat-sub">score 4.5‚Äì7</div></div>
  <div class="stat-card"><div class="stat-label">üü¢ Low Risk</div><div class="stat-value green-v" id="stat-low">‚Äî</div><div class="stat-sub">score below 4.5</div></div>
</div>

<div class="main">
  <aside class="sidebar">
    <div class="sidebar-section">
      <h3>Risk Level</h3>
      <div class="risk-pills">
        <div class="risk-pill active" data-risk="all">All</div>
        <div class="risk-pill" data-risk="high">üî¥ High</div>
        <div class="risk-pill" data-risk="medium">üü° Med+</div>
        <div class="risk-pill" data-risk="low">üü¢ Low</div>
      </div>
    </div>

    <div class="sidebar-section">
      <h3>Filter Permits</h3>
      <div class="filter-group">
        <span class="filter-label">City</span>
        <div class="city-pills" id="city-pills">
          <div class="pill active" data-city="">All Cities</div>
        </div>
      </div>
      <div class="filter-group">
        <label class="filter-label">Permit Type (keyword)</label>
        <input type="text" id="filter-type" placeholder="electrical, plumbing, new construction...">
      </div>
      <div class="filter-group">
        <label class="filter-label">Min Project Value ($)</label>
        <input type="number" id="filter-value" placeholder="e.g. 50000">
      </div>
      <div class="filter-group">
        <label class="filter-label">Issued Within</label>
        <select id="filter-days">
          <option value="">All time</option>
          <option value="7">Last 7 days</option>
          <option value="30" selected>Last 30 days</option>
          <option value="60">Last 60 days</option>
          <option value="90">Last 90 days</option>
          <option value="180">Last 6 months</option>
        </select>
      </div>
      <div class="filter-group">
        <label class="filter-label">ZIP Code</label>
        <input type="text" id="filter-zip" placeholder="e.g. 78701">
      </div>
      <div class="filter-group">
        <label class="filter-label">Results per page</label>
        <select id="filter-limit">
          <option value="50">50</option>
          <option value="100" selected>100</option>
          <option value="250">250</option>
          <option value="500">500 (max)</option>
        </select>
      </div>
      <button class="btn btn-primary" onclick="fetchPermits()">Search Permits</button>
      <button class="btn btn-secondary" onclick="resetFilters()">Reset</button>
    </div>

    <div class="sidebar-section">
      <h3>Quick Filters</h3>
      <div style="display:flex;flex-direction:column;gap:6px;">
        <button class="quick-btn" onclick="applyQuickFilter('commercial')">üèóÔ∏è Commercial $100K+</button>
        <button class="quick-btn" onclick="applyQuickFilter('large')">üí∞ Large Projects $500K+</button>
        <button class="quick-btn" onclick="applyQuickFilter('new_construction')">üè¢ New Construction</button>
        <button class="quick-btn" onclick="applyQuickFilter('high_risk')">üî¥ High Risk Areas</button>
      </div>
    </div>

    <div class="sidebar-section">
      <h3>Use Cases</h3>
      <div style="font-size: 12px; color: var(--muted); line-height: 1.9;">
        ‚úì Security trailer placement<br>
        ‚úì Equipment rental targeting<br>
        ‚úì Temp fencing leads<br>
        ‚úì Portable toilet services<br>
        ‚úì Construction supply sales
      </div>
    </div>
  </aside>

  <section class="results">
    <div class="results-header">
      <div>
        <div class="results-count" id="results-count">Loading permits...</div>
        <div class="click-hint">Click any row for full details + risk breakdown</div>
      </div>
      <button class="export-btn" onclick="exportCSV()">‚¨á Export CSV</button>
    </div>
    <div id="table-container">
      <div class="state-center"><div class="spinner"></div><span>Fetching permits...</span></div>
    </div>
  </section>
</div>

<div class="api-section">
  <div class="api-grid">
    <div class="api-card">
      <h4>üì° Risk-Aware API</h4>
      <p>Filter by risk level directly in the API for automated lead routing.</p>
      <div class="api-endpoint">/permits?risk=high&city=austin&min_value=100000</div>
    </div>
    <div class="api-card">
      <h4>üìä Risk Scoring</h4>
      <p>Census ACS poverty rates ‚Üí crime score. Median building age ‚Üí fire score.</p>
      <div class="api-endpoint">/stats ‚Äî risk distribution by level</div>
    </div>
    <div class="api-card">
      <h4>üîÑ Auto-Refreshed</h4>
      <p>Permits refresh daily. Risk scores refresh weekly from Census ACS.</p>
      <div class="api-endpoint">/health ‚Äî scored ZIP count</div>
    </div>
    <div class="api-card">
      <h4>üèôÔ∏è Expanding Coverage</h4>
      <p>Austin TX, Kansas City MO, San Diego CA, San Francisco CA, Philadelphia PA active. Houston, Nashville coming soon.</p>
      <div class="api-endpoint">/permits?risk=high&days=30&limit=500</div>
    </div>
  </div>
</div>

<!-- Detail Modal -->
<div class="modal-overlay" id="modal" onclick="closeModal(event)">
  <div class="modal">
    <div class="modal-header">
      <h2 id="modal-title">Permit Details</h2>
      <button class="modal-close" onclick="closeModalDirect()">√ó</button>
    </div>
    <div class="modal-body" id="modal-body"></div>
  </div>
</div>

<script>
  let currentCity = '';
  let currentRisk = '';
  let allResults = [];

  // Generate a consistent color pair for any city key
  function cityColor(key) {
    const palettes = [
      { bg: '#3b2a1a', fg: '#fb923c' }, // orange
      { bg: '#1a2e3a', fg: '#38bdf8' }, // sky blue
      { bg: '#1e3a1e', fg: '#4ade80' }, // green
      { bg: '#1a2e2e', fg: '#22d3ee' }, // cyan
      { bg: '#2d1f3a', fg: '#c084fc' }, // purple
      { bg: '#3a1a1a', fg: '#f87171' }, // red
      { bg: '#2e2a1a', fg: '#fbbf24' }, // amber
      { bg: '#1a3a2e', fg: '#34d399' }, // emerald
      { bg: '#1a1a3a', fg: '#818cf8' }, // indigo
      { bg: '#3a2e1a', fg: '#f59e0b' }, // yellow
      { bg: '#1a2a3a', fg: '#60a5fa' }, // blue
      { bg: '#2a3a1a', fg: '#a3e635' }, // lime
    ];
    let hash = 0;
    for (let i = 0; i < key.length; i++) hash = (hash * 31 + key.charCodeAt(i)) >>> 0;
    return palettes[hash % palettes.length];
  }

  function cityLabel(key) {
    return key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
  }

  function cityTagHTML(cityKey) {
    const c = cityColor(cityKey);
    return `<span class="city-tag" style="background:${c.bg};color:${c.fg}">${cityLabel(cityKey)}</span>`;
  }

  function bindCityPills() {
    document.querySelectorAll('.pill[data-city]').forEach(p => p.addEventListener('click', () => {
      document.querySelectorAll('.pill[data-city]').forEach(x => x.classList.remove('active'));
      p.classList.add('active'); currentCity = p.dataset.city;
    }));
  }
  bindCityPills();

  document.querySelectorAll('.risk-pill[data-risk]').forEach(p => p.addEventListener('click', () => {
    document.querySelectorAll('.risk-pill[data-risk]').forEach(x => x.classList.remove('active'));
    p.classList.add('active'); currentRisk = p.dataset.risk === 'all' ? '' : p.dataset.risk;
  }));

  async function loadStats() {
    try {
      const [data, health] = await Promise.all([
        fetch('/stats').then(r => r.json()),
        fetch('/health').then(r => r.json()),
      ]);
      document.getElementById('stat-total').textContent = data.total.toLocaleString();
      document.getElementById('stat-zips').textContent = (health.risk_scores || 0).toLocaleString();
      const rd = {};
      (data.risk_distribution || []).forEach(x => rd[x.risk_level] = x.count);
      document.getElementById('stat-high').textContent = (rd.HIGH || 0).toLocaleString();
      document.getElementById('stat-med').textContent = (rd.MEDIUM || 0).toLocaleString();
      document.getElementById('stat-low').textContent = (rd.LOW || 0).toLocaleString();

      // Build city pills dynamically from what's in the DB
      const container = document.getElementById('city-pills');
      const cities = (data.by_city || []).filter(c => c.count > 0);
      const existing = new Set([...container.querySelectorAll('.pill[data-city]')].map(p => p.dataset.city));
      cities.forEach(({ city }) => {
        if (!existing.has(city) && city) {
          const pill = document.createElement('div');
          pill.className = 'pill';
          pill.dataset.city = city;
          pill.textContent = cityLabel(city);
          pill.addEventListener('click', () => {
            document.querySelectorAll('.pill[data-city]').forEach(x => x.classList.remove('active'));
            pill.classList.add('active'); currentCity = city;
          });
          container.appendChild(pill);
        }
      });
    } catch(e) {}
  }

  async function fetchPermits() {
    const params = new URLSearchParams();
    if (currentCity) params.set('city', currentCity);
    if (currentRisk) params.set('risk', currentRisk);
    const type = document.getElementById('filter-type').value.trim();
    const minVal = document.getElementById('filter-value').value.trim();
    const days = document.getElementById('filter-days').value;
    const zip = document.getElementById('filter-zip').value.trim();
    const limit = document.getElementById('filter-limit').value;
    if (type) params.set('type', type);
    if (minVal) params.set('min_value', minVal);
    if (days) params.set('days', days);
    if (zip) params.set('zip', zip);
    params.set('limit', limit);

    document.getElementById('table-container').innerHTML = '<div class="state-center"><div class="spinner"></div><span>Loading...</span></div>';
    document.getElementById('results-count').textContent = 'Loading...';
    try {
      const data = await fetch('/permits?' + params).then(r => r.json());
      allResults = data.results || [];
      renderTable(allResults);
      document.getElementById('results-count').innerHTML = `<strong>${allResults.length.toLocaleString()}</strong> permits found`;
    } catch(e) {
      document.getElementById('table-container').innerHTML = '<div class="state-center">‚ö† Error loading permits.</div>';
    }
  }

  function fmt(val) {
    if (!val || val === 0) return null;
    if (val >= 1e6) return '$' + (val/1e6).toFixed(2) + 'M';
    if (val >= 1e3) return '$' + (val/1e3).toFixed(0) + 'K';
    return '$' + val.toLocaleString();
  }

  function riskBadge(level) {
    const icon = { HIGH: 'üî¥', MEDIUM: 'üü°', LOW: 'üü¢' };
    if (!level) return `<span class="risk-badge UNKNOWN">‚Äî</span>`;
    return `<span class="risk-badge ${level}">${icon[level]||''} ${level}</span>`;
  }

  function renderTable(results) {
    if (!results.length) {
      document.getElementById('table-container').innerHTML = '<div class="state-center">No permits match your filters.</div>';
      return;
    }
    const rows = results.map((r, i) => {
      const rl = r.risk_level || '';
      return `<tr class="risk-${rl.toLowerCase()}" onclick="openModal(${i})">
        <td>${cityTagHTML(r.city)}</td>
        <td class="trunc" title="${r.address||''}">${r.address||'‚Äî'}</td>
        <td class="trunc" title="${r.permit_type||''}" style="color:var(--muted)">${r.permit_type||'‚Äî'}</td>
        <td class="${r.estimated_value ? 'value-cell' : 'value-zero'}">${fmt(r.estimated_value)||'‚Äî'}</td>
        <td>${riskBadge(r.risk_level)}</td>
        <td class="trunc" title="${r.contractor_name||''}">${r.contractor_name||'‚Äî'}</td>
        <td>${r.permit_date||'‚Äî'}</td>
      </tr>`;
    }).join('');
    document.getElementById('table-container').innerHTML = `
      <table>
        <thead><tr>
          <th>City</th><th>Address</th><th>Permit Type</th>
          <th>Est. Value</th><th>Risk</th><th>Contractor</th><th>Date</th>
        </tr></thead>
        <tbody>${rows}</tbody>
      </table>`;
  }

  function openModal(i) {
    const r = allResults[i];
    if (!r) return;
    document.getElementById('modal-title').textContent = r.address || 'Permit Details';

    const crimeScore = r.crime_score || 0;
    const fireScore = r.fire_score || 0;
    const crimeColor = crimeScore >= 7 ? '#ef4444' : crimeScore >= 5 ? '#f59e0b' : '#10b981';
    const fireColor = fireScore >= 7 ? '#ef4444' : fireScore >= 5 ? '#f59e0b' : '#10b981';
    const povertyPct = r.poverty_rate ? r.poverty_rate.toFixed(1) + '%' : 'N/A';
    const buildYear = r.median_build_year || 'N/A';
    const hasRisk = crimeScore > 0 || fireScore > 0;

    document.getElementById('modal-body').innerHTML = `
      <div class="modal-section">
        <div class="modal-section-title">Project Overview</div>
        <div class="detail-grid">
          <div class="detail-item full"><label>Address</label><div class="val" style="font-size:16px">${r.address||'‚Äî'}</div></div>
          <div class="detail-item"><label>City</label><div class="val">${cityTagHTML(r.city)}</div></div>
          <div class="detail-item"><label>ZIP Code</label><div class="val">${r.zip_code||'‚Äî'}</div></div>
          <div class="detail-item"><label>Estimated Value</label><div class="${r.estimated_value ? 'val-big' : 'val'}">${fmt(r.estimated_value)||'‚Äî'}</div></div>
          <div class="detail-item"><label>Date Issued</label><div class="val">${r.permit_date||'‚Äî'}</div></div>
          <div class="detail-item"><label>Permit Type</label><div class="val">${r.permit_type||'‚Äî'}</div></div>
          <div class="detail-item"><label>Status</label><div class="val">${r.status||'‚Äî'}</div></div>
        </div>
      </div>

      ${hasRisk ? `
      <div class="modal-section">
        <div class="modal-section-title">Area Risk Assessment</div>
        <div class="risk-section">
          <div class="risk-header">
            <div class="risk-title">ZIP ${r.zip_code} Risk Profile</div>
            ${riskBadge(r.risk_level)}
          </div>
          <div class="risk-bars">
            <div class="risk-bar-row">
              <div class="risk-bar-label">Crime Risk</div>
              <div class="risk-bar-track"><div class="risk-bar-fill" style="width:${crimeScore*10}%;background:${crimeColor}"></div></div>
              <div class="risk-bar-score" style="color:${crimeColor}">${crimeScore}/10</div>
            </div>
            <div class="risk-bar-row">
              <div class="risk-bar-label">Fire Risk</div>
              <div class="risk-bar-track"><div class="risk-bar-fill" style="width:${fireScore*10}%;background:${fireColor}"></div></div>
              <div class="risk-bar-score" style="color:${fireColor}">${fireScore}/10</div>
            </div>
          </div>
          <div class="risk-bar-note">
            Crime score based on Census poverty rate: <strong>${povertyPct}</strong> in this ZIP.<br>
            Fire score based on median building age: built <strong>${buildYear}</strong>.
          </div>
        </div>
      </div>` : `
      <div class="modal-section">
        <div class="modal-section-title">Area Risk Assessment</div>
        <div class="description-box" style="color:var(--muted)">Risk data not yet available for ZIP ${r.zip_code||'unknown'}. Scores load after the initial Census data fetch completes.</div>
      </div>`}

      ${r.description ? `
      <div class="modal-section">
        <div class="modal-section-title">Work Description</div>
        <div class="description-box">${r.description}</div>
      </div>` : ''}

      <div class="modal-section">
        <div class="modal-section-title">Contractor / Applicant</div>
        <div class="description-box" style="font-size:15px;font-weight:500">${r.contractor_name||'Not listed'}</div>
      </div>

      <div class="modal-actions">
        <button class="modal-btn" onclick="window.open('https://www.google.com/maps/search/'+encodeURIComponent('${(r.address||'').replace(/'/g,'')} ${r.city||''}'),'_blank')">üó∫ View on Maps</button>
        <button class="modal-btn" onclick="navigator.clipboard.writeText('${(r.address||'').replace(/'/g,'')} ${cityLabel(r.city)||''}').then(()=>alert('Copied!'))">üìã Copy Address</button>
        <button class="modal-btn" onclick="closeModalDirect()">‚úï Close</button>
      </div>
    `;
    document.getElementById('modal').classList.add('open');
    document.body.style.overflow = 'hidden';
  }

  function closeModal(e) { if (e.target === document.getElementById('modal')) closeModalDirect(); }
  function closeModalDirect() { document.getElementById('modal').classList.remove('open'); document.body.style.overflow = ''; }
  document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModalDirect(); });

  function applyQuickFilter(preset) {
    resetFiltersState();
    if (preset === 'commercial') {
      document.getElementById('filter-value').value = '100000';
      document.getElementById('filter-type').value = 'commercial';
      document.getElementById('filter-days').value = '30';
    } else if (preset === 'large') {
      document.getElementById('filter-value').value = '500000';
      document.getElementById('filter-days').value = '60';
    } else if (preset === 'new_construction') {
      document.getElementById('filter-type').value = 'new construction';
      document.getElementById('filter-days').value = '30';
    } else if (preset === 'high_risk') {
      document.querySelectorAll('.risk-pill').forEach(p => p.classList.remove('active'));
      document.querySelector('.risk-pill[data-risk="high"]').classList.add('active');
      currentRisk = 'high';
      document.getElementById('filter-days').value = '30';
    }
    fetchPermits();
  }

  function resetFiltersState() {
    document.getElementById('filter-type').value = '';
    document.getElementById('filter-value').value = '';
    document.getElementById('filter-days').value = '30';
    document.getElementById('filter-zip').value = '';
    document.getElementById('filter-limit').value = '100';
    document.querySelectorAll('#city-pills .pill').forEach(p => p.classList.remove('active'));
    document.querySelector('#city-pills .pill[data-city=""]').classList.add('active');
    document.querySelectorAll('.risk-pill').forEach(p => p.classList.remove('active'));
    document.querySelector('.risk-pill[data-risk="all"]').classList.add('active');
    currentCity = ''; currentRisk = '';
  }

  function resetFilters() {
    resetFiltersState();
    fetchPermits();
  }

  function exportCSV() {
    if (!allResults.length) return alert('Run a search first.');
    const h = ['city','address','permit_type','estimated_value','contractor_name','permit_date','zip_code','status','description','risk_level','crime_score','fire_score','poverty_rate','median_build_year'];
    const csv = [h.join(','), ...allResults.map(r => h.map(k => JSON.stringify(r[k]??'')).join(','))].join('\n');
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
    a.download = 'permits-with-risk.csv';
    a.click();
  }

  loadStats();
  fetchPermits();
</script>
</body>
</html>
